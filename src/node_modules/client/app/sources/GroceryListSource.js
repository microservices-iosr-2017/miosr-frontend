import axios from 'axios';
import jsonpatch from 'fast-json-patch';
import {arrayOf} from 'normalizr';
import GroceryListActions from 'actions/GroceryListActions';
import createAsync from './create-async';
import cacheThenNetwork from './cache-then-network';
import groceryList from './schemas/groceries';

const GROCERY_LISTS_PATH = '/api/grocery_lists';
const groceryListPath = id => `${GROCERY_LISTS_PATH}/${id}`;

const GroceryListSource = {
  fetch: {
    request: cacheThenNetwork({
      remote: () => axios.get(GROCERY_LISTS_PATH),
      local: () => caches.match(GROCERY_LISTS_PATH),
    }),
    success: GroceryListActions.fetchSuccess,
    error: GroceryListActions.fetchFailure,
    normalized: arrayOf(groceryList),
  },
  create: {
    request: data => axios.post(GROCERY_LISTS_PATH, data),
    success: GroceryListActions.createSuccess,
    error: GroceryListActions.createFailure,
    normalized: groceryList,
  },
  update: {
    request: (list, newList) => {
      const data = jsonpatch.compare(list, newList);
      return axios.patch(groceryListPath(list._id), data);
    },
    success: GroceryListActions.updateSuccess,
    error: GroceryListActions.updateFailure,
    normalized: groceryList,
  },
  remove: {
    request: id => axios.delete(groceryListPath(id)),
    success: GroceryListActions.removeSuccess,
    error: GroceryListActions.removeFailure,
    normalized: groceryList,
  },
};

export default createAsync(GroceryListSource);
