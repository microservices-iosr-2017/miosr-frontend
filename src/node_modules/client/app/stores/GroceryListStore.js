import flow from 'lodash/fp/flow';
import clone from 'lodash/clone';
import values from 'lodash/values';
import assign from 'lodash/assign';
import set from 'lodash/fp/set';
import unset from 'lodash/fp/unset';
import alt from 'alt-instance';

import GroceryListActions from 'actions/GroceryListActions';
import GroceryListSource from 'sources/GroceryListSource';

const updateList = (list, updater) => flow(
  clone,
  updater
)(list);

class GroceryListStore {
  static config = {
    getState(currentState) {
      return assign({}, currentState, {lists: values(currentState.lists)});
    }
  };

  constructor() {
    this.lists = {};
    this.err = null;
    this.loading = false;

    this.bindListeners({
      handleFetchLists: GroceryListActions.FETCH_LISTS,
      handleFetchSuccess: GroceryListActions.FETCH_SUCCESS,
      handleFailure: [
        GroceryListActions.FETCH_FAILURE,
        GroceryListActions.CREATE_FAILURE,
        GroceryListActions.REMOVE_FAILURE,
      ],
      handleCreateSuccess: GroceryListActions.CREATE_SUCCESS,
      handleUpdateSuccess: GroceryListActions.UPDATE_SUCCESS,
      handleRemoveSuccess: GroceryListActions.REMOVE_SUCCESS,
      handleCreateList: GroceryListActions.CREATE_LIST,
      handleRemoveList: GroceryListActions.REMOVE_LIST,
      handleCreateItem: GroceryListActions.CREATE_ITEM,
      handleRemoveItem: GroceryListActions.REMOVE_ITEM,
      handleToggleItem: GroceryListActions.TOGGLE_ITEM,
    });

    this.exportPublicMethods({list: this.list.bind(this)});
  }

  list(id) {
    return this.lists[id];
  }

  handleFetchLists() {
    if (!this.loading) {
      this.setState({loading: true});
      GroceryListSource.fetch();
    }
  }

  handleFetchSuccess({entities}) {
    this.setState({lists: entities.groceryLists, err: null, loading: false});
  }

  handleCreateList(list) {
    GroceryListSource.create(list);
  }

  handleCreateSuccess({result, entities}) {
    this.setState({lists: set(result, entities.groceryLists[result])(this.lists)});
  }

  handleFailure(err) {
    this.setState({err, loading: false});
  }

  handleRemoveList(listId) {
    GroceryListSource.remove(listId);
  }

  handleRemoveSuccess({result}) {
    this.setState({lists: unset(result)(this.lists)});
  }

  handleUpdateList(listId, updater) {
    const list = this.list(listId);
    const newList = updateList(list, updater);
    GroceryListSource.update(list, newList);
  }

  handleUpdateSuccess({result, entities}) {
    this.setState({lists: set(result, entities.groceryLists[result])(this.lists)});
  }

  handleCreateItem({listId, item}) {
    this.handleUpdateList(listId, (list) => {
      list.items = list.items.concat([item]);
      return list;
    });
  }

  handleRemoveItem({listId, itemId}) {
    this.handleUpdateList(listId, (list) => {
      list.items = list.items.filter(item => item._id !== itemId);
      return list;
    });
  }

  handleToggleItem({listId, itemId}) {
    this.handleUpdateList(listId, (list) => {
      const index = list.items.findIndex(item => item._id === itemId);
      const item = list.items[index];
      list.items = [
        ...list.items.slice(0, index),
        assign({}, item, {completed: !item.completed}),
        ...list.items.slice(index + 1)
      ];
      return list;
    });
  }
}

export default alt.createStore(GroceryListStore, 'GroceryListStore');
