'use strict';

/* SERVER CODE ENTRY POINT
 * How server's initialization progresses from now?
 * - app.js
 *   - config/environment/index.js
 *     index.js holds default values, which are merged with shared.js and environment
 *     specific file (development.js, production.js, test.js)
 *   - mongo connection creation
 *   - database seeding (only in dev)
 *   - config/express - middleware setup
 *     also sets up from where static assets are served
 *   - routes.js - endpoints registration
 *   - serverStart - only callbacks from now on
 * */

// Set default node environment to development
var env = process.env.NODE_ENV = process.env.NODE_ENV || 'development';

/* in dev/test mode babel is used at runtime
 for production build, files must be transpiled */
if(env === 'development' || env === 'test') {
  require('babel-register')({
    /* for some reason it ignores 'only' section from nearest .babelrc file, so
    * it must be repeated manually.
    * See https://github.com/babel/babel.github.io/issues/703 */
    only: /src\/node_modules/,
  });
}

/* guarantee it's always set */
if(!process.env.SERVER_ROOT) {
  process.env.SERVER_ROOT = __dirname;
}

// Export the application
module.exports = require('./app');
